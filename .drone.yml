matrix:
  ARCH:
    - amd64
    - arm

platform: linux/${ARCH}

pipeline:
  publish:
    image: plugins/docker:latest
    secrets: [ DOCKER_USERNAME, DOCKER_PASSWORD ]
    repo: justinbarrick/drone-manifest
    tags:
    - ${ARCH}-latest
    - ${ARCH}-${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:7}
    - ${ARCH}
    when:
      branch: master

  manifest:
    image: justinbarrick/drone-manifest:${ARCH}-latest
    repo: justinbarrick/drone-manifest
    tag: latest
    images:
      - repo: justinbarrick/drone-helm
        tag: arm
        annotations:
          arch: arm
      - repo: justinbarrick/drone-helm
        tag: amd64
        annotations:
          arch: amd64
